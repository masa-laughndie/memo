# アプリケーションが動くための階層

ハードウェア > OS > ミドルウェア > アプリケーション

# ミドルウェア

アプリケーションと OS の中間的な処理を行うソフトウェア
OS の基本的な機能に対して拡張 or アプリケーションの汎用的な機能を集めたもの
主な構成要素としては以下。

- web サーバ
- AP サーバ
- DB サーバ

その他

- 高可用クラスタ ... クラスタに参加してるノードの管理、ミドルウェアの監視など
- バックアップ
- ジョブ運用
- ...

## web サーバ

web ブラウザからのリクエストに対して、レスポンス(静的画面や画像など)を返すもの

何がしかの箱(=ハード)に web サーバ用のソフトを入れることで web サーバになる。
=> PC に web サーバーのソフトを入れれば web サーバになる。

### 主な web サーバソフトの種類

- Apache ... 高い信頼性と充実した機能を持つ。大量のアクセスに対してエスポンスが遅くなる欠点がある。
- Nginx ... Apache の問題である大量のアクセスに対応。高速で処理できる。
- IIS ... Microsoft Windows 標準 web サーバ。

#### Apache

<利用される理由>

- CMS(Contents Management System, Wordpress などの web 関連の知識(ex: html.css)を必要とせずにサイトが作れるサービス)を利用する際に比較的簡単に設定できる
- リファレンスが多い
- レンタルサーバーのプランに組み込まれていることが多い
- 高速化表示対策がされている
- セキュリティ対策が随時更新されている

<特徴>

- OSS
- モジュールにより拡張可能
- Linux だけでなく複数のサーバー OS 上で利用可能
- マルチプロセスモデル => 接続ごとにプロセスをフォーク(=コピー)するのでメモリがいっぱいになりやすい
- プロセス駆動アーキテクチャ
  - 各リクエストをプロセスに割り当てて処理するため、大量のリクエストに対してプロセスが同時に起動しオーバーヘッド(負荷処理)が大きくなるデメリットがある。

<向いてる状況>

- 低負荷で同時アクセスが少なく、単純にリクエスト数が多い

#### Nginx

<特徴>

- OSS
- 早くて高負荷に強い
- リバースプロキシが使える
  - プロキシ ,,, web ブラウザの代わりに、 web サーバーにリクエストを送って、レスポンスを受けるサーバ。「web ブラウザ + プロキシサーバ」 = クライアント というイメージ
    - メリット ... 身元が隠せる。
  - リバースプロキシ ... web ブラウザのリクエストを受けて、 レスポンスを web サーバーの代わりに返すサーバ・「リバースプロキシサーバ + web サーバー」 = サーバ というイメージ
    - メリット ... 身元が隠せる。負荷分散できる。( => 複数の web サーバを用意して負荷を分散できる)
- ロードバランサが使える
  - ロードバランサ ... 負荷分散装置
- シングルスレッドモデル
- イベント駆動アーキテクチャ
  - Node.js 同様にイベントループ方式 => キューに溜まったイベントを処理していく処理方式
  - 少量のプロセスで大量のイベントをさばくことが可能

<向いてる状況>

- 高負荷でスケーラビリティが要求される
- 静的なページに同時多数のアクセスが想定される

### プロセス管理

プロセス ... プログラムの実行単位であり、CPU 時間単位で割り振られる。タスクとも呼ばれる。

- 状態が存在する
  - 実行状態 => CPU を使用して実行中の状態
  - 実行可能状態 => 実行可能だが、他の優先度の高いプロセスが実行中のため待機している状態
  - 待ち状態 => 入出力待ちなどにより、CPU の使用権を与えられても使用できない待ちの状態
  - ...
- CPU はプロセスを実行する場合にそのプロセスの持つメモリデータに対して演算を行う
- メモリ上の構造データは「テキストセグメント」と「データセグメント」から成る
  - テキストセグメント ... プログラムの命令列
  - データセグメント ... プロセッサの情報やプロセス管理用のデータ領域
- プロセス間でメモリ空間やファイルハンドラなどのリソースを共有しない

スレッド ... CPU を利用するための実行単位で、最小処理単位の概念。1 つのプロセスの中で複数の実行単位を持てるように機能拡張したもの。

- スレッド間でメモリ空間やファイルハンドラなどのリソースを共有する

<プロセスとスレッドの関係>
プロセスの中に複数のスレッドが存在する場合がある
プロセスが終了するとスレッドも終了する

プロセスのみの場合は複数の CPU に対して、１プロセスに対し、１つの CPU しか使わないため、そのプロセスが複雑で大きな処理だと次のプロセスが走るまでに時間がかかる。
それに対し、マルチスレッドを有するプロセスの場合は１スレッドに１つの CPU に使えるのでスレッドで分担して並行的にプロセスの処理を進めれ、早く処理を終わらせることが可能である。

![prosess_and_thread1](https://camo.qiitausercontent.com/a54f9c17b47726a536b287df28cef408484442f9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303437342f64353666336263352d356637342d386234342d353962322d3634353437393435343761392e706e67)

### web サーバ実装モデル

web サーバの主な関心はリクエスト処理をどのように効率よく捌くかと並行実行するか

- シリアルモデル
  - 並行処理はせず逐次的に処理するだけの最も単純なモデル
  - 開発用とでの並行処理はいらないので、手元のローカル環境などはこのモデルで動かしたりする
- マルチプロセスモデル
  - リクエストを受信するたびに子プロセスを fork により生成し、処理させる
  - 一般的に fork はメモリ上のプロセスのアドレス空間にを丸ごとコピーするため遅いと言われるが、実際は OS のメモリ管理の最適化手法の１つで Copy On Write(COW)により負荷を抑えている
    - Copy On Write(COW) ...

## AP サーバ

アプリケーションサーバの略。
web サーバが静的なコンテンツをクライアントに返すのに対して、その中でも動的なコンテンツは web サーバから AP サーバにリクエストを送り、処理をしてもらって、 web サーバにレスポンスを返す。

以前は DB サーバと web サーバンのいわゆる「web ２層構造」だったため、 web サーバが今の web サーバと AP サーバの役割を担っていたが、
現在はサーバの負荷分散などの様々なメリットにより AP サーバも加えた「web ３層構造」となり web サーバと役割を分担するようになった。
ただ、静的なコンテンツのみの場合などは今も web サーバのみだったりするっぽい。

「web ２層構造」 ... web サーバ <-> DB サーバ
「web ３層構造」 ... web サーバ <-> AP サーバ <-> DB サーバ
<メリット>

- 負荷分散
  - 単純に役割分担されることで負荷が分散する
- セキュリティの向上
  - 層の間にセキュリティソフトなどを挟める
- 管理、運用のしやすさ
  - そのサーバ関連の変更はそのサーバ内で完結できる

<デメリット>

- コストがかかる

## DB サーバ

データベース管理システム(DBMS)が動作しているサーバ
データが保管されている場所ではない(それはストレージ)
ストレージに新たなデータを書き込んだり、読み込み、更新などを行う
