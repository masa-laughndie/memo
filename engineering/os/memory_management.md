# メモリ管理

PC のメモリの管理をするもの。
主に、プログラムの要求に応じてメモリの一部を割り当てる方法と、そのメモリが不要になった時に再利用するために解放する方法を提供する

## 前提

**UNIX のプログラム実行の目標**

1. 複数のプログラムを同時に実行する
2. 物理メモリを効率よく管理する
3. あるプログラムが他のプログラムに悪影響を与えないようにする

**目標のために必要な機能**

- 物理メモリより大きいサイズのプログラムを実行できること(理想は任意のサイズ)
- 部分的にロードされたプログラムを実行できること
- 一度に複数のプログラムがメモリに存在できること
- プログラムを任意のアドレスにロードでき、実行中に移動(再配置)できること
- 物理メモリのサイズや構成に関係なくプログラムを記述できること
- 同じプログラム・コードが共有できること

↓

- 上記により。メモリの確保管理からプログラマを解放すること

## 物理メモリの構成

![物理メモリの構成](https://uralowl.my.coocan.jp/unix/job/UNIX/kernel/GIF/1.gif)

- カーネル・テキスト ... カーネルの実行可能なコード領域
- カーネル・データ ... カーネルが使用する変数領域
- ユーザページ
- アドレス空間の穴

## 仮想記憶システム

アプリケーションに対して物理メモリとは関係なくあたかも大きなメモリを利用しているように見せて、仮想アドレスを提供し、内部的には物理アドレス変換して物理メモリを間接的に割り当てるシステム。
(仮想アドレス空間) -- 仮装アドレス --> (アドレス変換テーブル) -- 物理アドレス --> (物理メモリ)

効率よくメモリを使用できる半面、デメリットとしては変換テーブルの管理を行う必要があり、その分のメモリも必要となることや、実行時にアドレス変換が発生すると実行速度が遅くなることなどがある。
アドレス変換テーブルや変換テーブルのキャッシュはハードウェアで実現されることが多い

実現方法として「ページング」がある。

### ページング

- 仮想アドレス空間と物理メモリを固定サイズにのメモリ領域に分割し、領域単位で管理、割り当てを行う
- 構成要素
  - ページ ... 分割された仮想アドレス空間
  - ページフレーム ... 分割された物理メモリ
  - ページテーブル ... ページとページフレームを対応づける変換テーブル
- 仮想アドレスは「ページ」番号と「そのページのオフセット(相対的な位置)番号」で構成される

**変換手順**

1. ページの仮想アドレスをページ番号とオフセットに分割する
2. ページテーブルを利用して、仮想アドレスのページからページフレームを探す
3. ページフレームのアドレスとオフセットから物理アドレスを計算する

**ページテーブルの構成**

- 有効フラグ ... ページテーブルが有効かどうかを表すフラグ
- 物理ページフレーム番号
- アクセス制御情報 ... ページの利用方法。(ex: 書き込む可能か、実行コードを含むか...)

### デマンドページング

- アクセスされた仮想ページだけをメモリロードするテクニック

### スワッピング

- プロセス実行に必要な物理メモリの空きがないときに別ページのをメモリから取り除くことでそのページの空間を確保すること
- **スラッシング** ... スワップ対象ページを決めるためのアルゴリズム効率が悪いとページが絶え間なくディスクに書き込まれたりして読み込まれたりしてカーネルがそれに時間を取られ、本来の仕事ができなくなる状態

## プロセスのメモリ配置

以下のセグメント(連続したメモリ領域、ページの集合体)で構成される

- テキスト・セグメント ... 機械語命令(実行コード)を置く領域
- データ・セグメント ... データを置く領域
  - データ ... 初期値つき静的変数やグローバル変数
  - BSS (Block Started by Symbol) ... 初期値なしの静的変数やグローバル変数
  - ヒープ ... 実行時に大きさが決まる変数を確保する領域。(`malloc()` で確保する変数の領域。)
- スタック・セグメント ... スタックとして使用するメモリ領域。(ex: C 言語での自動変数、関数の引数、関数の戻り番地...)

# 参考

- http://uralowl.my.coocan.jp/unix/job/UNIX/kernel/memory.html
