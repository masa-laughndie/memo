#  表記ゆれ正規化 API アーキテクチャ仕様検討

## あるべき姿(目的)

- 検索ワード(in)に対して、表記ゆれがある場合にその代表語を返す(out)

(懸念事項)

- 検索するたびに API にアクセスするため  
  => できるだけレスポンスが早い必要がある
- 同時に検索されることがあるため  
  => ある程度、負荷に耐えられる必要がある

上記の観点をできるだけ満たし、かつコスト的にも抑えられるアーキテクチャを考える

## 考えるべき項目

- アプリケーション

  - API を分けるか？( = 表記ゆれ配列取得と代表語の選定を分けるか？)
  - 言語は何を使うか？

- インフラ
  - アプリケーションをどこに置くか？
    => serverless アーキテクチャ (Lambda) or アプリケーションサーバー (EC2)
  - 表記ゆれ辞書をどこに置くか？( = DB に何を使うか)
    => DynamoDB or RDS

---

## アプリケーション

### API を分けるか？( = 表記ゆれ配列取得と代表語の選定を分けるか？)

**分ける**

- メリット

  -  API ごとに他に転用できる箇所がある場合に転用しやすい  
    =>  転用するところなさそう

- デメリット
  -  リポジトリを分ける必要があるため、色々と手間がかかりそう

**分けない**

- メリット

  - リポジトリを統一できるので設定や管理が楽
  - 機能の複雑さもそこまで変わらないと予想できる

- デメリット
  -  特になし

( 意見)

- 分けない
  - 機能的に他に転用する可能性は低い 
  - 設定などが統一されるので楽

### 言語は何を使うか？

(意見)

- Go
  - 星さんの API で使われている
  -  小さい機能なので、 試しに触ってみたい

---

## インフラ

### アプリケーションをどこに置くか？

**severless アーキテクチャ(Lambda)**

- メリット

  - インフラまわりの構築と管理の手間が省ける
    - 環境設定不要
    - 起動・監視不要
    - オートスケーリングしてくれる  
      => ☆ 負荷に耐えられることに繋がる
  -  実装が楽
    - アプリケーションコードと Lambda ファンクション(トリガーに対する処理実行関数)をアップロードするだけいい。
  -  トリガーに対して起動するので、コストが抑えられる
    - リクエストのうち毎月最初の 1,000,000 件は無料。以後は 1,000,000 件のリクエストにつき 0.20 USD

- デメリット
  - AWS リソース(S3, DynamoDB, SQS...)と同じリージョンでなければならないという制約  
    => 基本同じリージョンなので特に問題なさそう
  - ステートレスなので、 複雑な機能への使用に向かない  
    => シンプルな機能なので問題ない
  - タイムアウト時間が最大 300 秒まで  
    => シンプルな機能なので問題ない

**アプリケーションサーバー (EC2)**

- メリット

  - 複雑な処理に対応できる  
    => 今回はシンプルな機能のため不要なメリット
  - タイムアウト時間がない  
    =>  そもそも短時間で処理できるようにするため不要なメリット

- デメリット

  - インフラの設定と管理が必要

(意見)

- Lambda が良さそう
  - 機能規模的にインフラの管理等のコストはかけたくないというニーズに合っている
  - 負荷にも耐えられる
  - コストも抑えられそう

ref

- [Lambda vs. EC2](https://dzone.com/articles/the-rise-of-lambda)

### 表記ゆれ辞書をどこに置くか？( = DB に何を使うか？)

(候補)

- DynamoDB
- RDS

**DynamoDB**

- メリット
  - 読み書きが早い
    => ☆ レスポンスの高速化に繋がる
- デメリット
  - シンプルなデータ構造にしか使えない
    => 今回は辞書なので中身はシンプル
  - 空文字が利用できない
    => しない
  -  ネット経由でのアクセスが必要

**RDS**

- メリット
  -  テーブル結合などの複雑なデータ構造を持てる  
    =>  辞書なのでテーブル結合はしない
  - SQL により操作可能  
    => そこまでアドバンテージにはならない
  -  ネット経由でのアクセスが不要
  - データの整合性が保てる  
    => 頻繁に消したり加えたりしないので  整合性はそこまでいらない
- デメリット
  - lambda との相性がよくなさそう
    - 色々と設定が必要
      - lambda を VPC に配置 or RDS をグローバルに配置する必要がある
        => lambda を VPC に接続するとレスポンスが遅くなる原因になるらしい
      - lambda の zip ファイルに MySQL などのライブラリの配置が必要

ref

- [何が違う？DynamoDB と RDS](http://blog.serverworks.co.jp/tech/2017/04/12/what_is_different_dynamodb_and_rds/)

(意見)

- DynamoDB
  - 読み書きが早い
  - テーブル結合不要なので RDS は機能過多、DynamoDB に適している
  - lambda との相性も良い
  - 頻繁にデータ更新はしないというところも DynamoDB の仕様想定に合っている

---

## アーキテクチャ構成の参考

- [pixta-title-translator](https://github.com/pixta-dev/pixta-title-translator)

  - lambda
  - DynamoDB
  - 言語 js

- https://dev.classmethod.jp/cloud/aws/serverless-first-dynamodb/

##  フロー想定

[WIP]
