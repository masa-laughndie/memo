# インフラの基礎知識

## システムの求められる要件

- 機能要件(functional requirement)

  - システムの機能として必要な要件
  - システムやソフトウェアで何ができるかをまとめたもの

- 非機能要件(non-functional requirement)

  - システムの性能、信頼性、拡張性、運用性、セキュリティなど機能要件以外全て
  - **システム基盤の知識が必要**

##  システム基盤の構成要素

- ハードウェア
  - システム基盤を構成する物理的要素
  - サーバー機器本体、データを保存するストレージ、電源装置など
- ネットワーク
  - システム利用者に遠隔地からアクセスできるようにサーバー群をつなぐための要素
  - ルーター、スイッチ、ファイアウォールなどのインターネット機器、ケーブル、アクセスポイントなど
- OS(Operating System)
  - ハードウェアやネットワーク機器を制御するための基本ソフトウェア
  - クライアント OS
    - Windows, iOS...
    - 利用者が使いやすいように GUI 機能やマルチメディア機能が用意されている
  - サーバ OS
    - Windows Server, Unix, Linux...
    - システムを高速かつ安定稼働させるために必要な機能に特化
- ミドルウェア
  - サーバ OS 上でサーバが特定の役割を果たすための機能をもつソフトウェア

## クラウドとオンプレミス

## オンプレミス

- 自社で自前のデータセンターを持ち、システム構築から運用までを行う形態
- OS やミドルウェアも全て自社で購入し、ライセンスの管理やバージョンアップも自前で行う

(適するケース)

- 高い可用性が求められる

  - ネットワークの瞬断が許されないなどのクラウドベンダーが保障する以上の可用性が必要となるミッションクリティカルシステム
    - クラウドではシステムの可用性をクラウドベンダーが保障している

- 機密性の高いデータを扱う

  - クラウドではデータの保存場所をクラウドサービス側が決める
  - 物理的な保管場所を明確にする必要があるデータはパブリッククラウド上に保管できない

- 特殊な要件がある

  - 汎用的ではないデバイス、特殊なプラットフォームでしか動かないシステムの場合にそれに大した環境を用意する必要がある

## クラウド

- パブリッククラウド
  - インターネットを介して不特定多数に提供されるクラウドサービス
  - サーバやネットワークなどのインフラに関する初期投資が不要
- プライベートクラウド
  - 特定の企業やグループのみに提供されるクラウドサービス
  - セキュリティが担保しやすかったり、独自の機能やサービスを追加しやすかったりする

(適するケース)

- トラフィックが変動しやすい

  - 主にコンシューマー向け(外向け)のシステムは正確なトラフィック予測が困難なため、
    トラフィック量に応じてサーバのスペックなどを容易にサイジングできる構成が向いており、
    クラウドはオートスケール機能などがそれにあたる

-  災害対策などのために海外などにバックアップを構築したい

  -  クラウドなら海外に容易にバックアップを構築可能などで有事の時にもシステム運用の継続が可能

- 早くサービスをリリースさせたい
  - オンプレミスは機器の調達や設定が必要だが、クラウドはその手間を省ける

## システム基盤の構築・運用フロー

- システム化計画・要件定義

↓

- インフラ設計

↓

- インフラ構築

↓

- 運用

# ハードウェア・ネットワークの基礎知識

## サーバ機器の構成要素

- CPU
  - プラグラムの計算や処理などを行う電子回路部品
  - 動作周波数が大きいほど演算能力が高くなる
  - コア(=演算回路)の数が多くなるほど同時に演算できる数が増える
- メモリ
  - CPU が直接アクセスできる記憶装置
- ストレージ
  - データーベースに書き込まれたデータなどの永続データを保存するデバイス

## ネットワークアドレス

- ネットの世界ではサーバやクライアント、各種ネットワークを識別するために主に２つのネットワークアドレスを使う

- MAC アドレス( 物理アドレス、イーサネットアドレス )

  - ネットワーク部品に物理的に割り当てられた 48 ビットのアドレス
    - 前半 24 ベットはネットワーク部品メーカーの識別番号
    - 後半 24 ビットは各メーカーが重複しないように割り当てる
    - 16 進数表記で 2 バイトずつ区切って表す

- IP アドレス
  - ネットワークに接続されたコンピュータやネットワーク機器に割り当てられた識別番号
  - IPv4
    - ８ビットずつ 4 つに区切られた 32 ビットで表される形式
    - 10 進数で表現。「192.168.1.1」
    - 広く普及
    - 2 の 32 乗(約 42 億)までしか１つのネットワークに接続できないことが懸念されている  
      => 社内ネットワークなどでは任意のアドレスを割り当てるプリベートアドレスを使用
  - グローバルアドレスの割り当ては世界中で  重複がないように各国の NIC(Network Information Center)が行なっている

## OSI 基本参照モデルと通信プロトコル

- 通信プロトコル

  - ネットワーク機器同士で通信を行う際の取り決め

- OSI 参照モデルでは通信プロトコルを７つの  階層に分けて定義
  - 下位層 ... 1 ~ 4
  - 上位層 ... 5 ~ 7

(階層)

- アプリケーション層(レイヤー７)
  - アプリケーションに特化したプロトコル
  - web の HTTP や  メール転送の SMTP など
- プレゼンテーション層(レイヤー６)
  - データ表現形式を  規定
  - データの保存形式や圧縮、文字コードなど
- セッション層(レイヤー５)
  - コネクション確立のタイミングやデータ転送のタイミングを規定
  - アプリケーション間で起こる要求(リクエスト)とレスピンス(応答)で構成
- トランスポート層(レイヤー４)
  - データ転送の制御を行う
  - 通信相手のノードにデータを確実に送る役割
  - TCP や UDP がある
- ネットワーク層(レイヤー３)
  - 異なるネットワークで通信するための規定
  - パケットをどこからどこに転送するかの情報を管理
- データリンク層(レイヤー２)
  - 同じネットワーク内にあるノード間の通信を規定
- 物理層(レイヤー１)
  - 通信機器の物理的。電気的な特性を規定

## ファイアウォール

- 内部ネットワークとその外部との通信を制御して内部ネットワークを安全に維持するための技術

- パケットフィルタ型
  - 通過するパケットをポート番号や IP アドレスをもとにフィルタリングする方法
  - パケットフィルタリングのルールのことを「ACL(アクセス制御リスト)」と呼ぶ
- アプリケーションゲートウェイ型
  - アプリケーションプロトコルのレベルで外部との通信を代替し制御する
  - プロキシサーバと呼ばれる。プロキシは「代理」の意。

# OS(Linux)の基礎知識

Docker は Linux の機能を使った技術であるため、 Docker を使用する上で Linux の基礎知識が必要

## Linux

- Unix  互換のサーバ OS
- セキュリティに優れ、安定して動作する
-  スマホや組み込み機器の OS としても動作している
- オープンソースで誰でも自由に改変 ・再配布できる

Linux という言葉は一般的に以下の２つの意味を持つ

- Linux カーネル

  - OS のコアとなる部分
  - OS としてハードウェアや  アプリケーションソフトを制御するための基本的な機能を実装したソフトウェア
  - C 言語やアセンブリ言語で書かれている
  - Android は Linux カーネル上に構築されている

- Linux ディストリビューション
  - Linux カーネルや各種コアンド、ライブラリ、アプリケーションをパッケージ化したもの
    - Linux カーネル以外の部分をユーザーランドと呼ぶ
    - ユーザーランドからは直接デバイスにアクセスできないので Linux カーネルを介して処理を行う

## Linux カーネル

### 主機能

- デバイス管理
  - ハードウェアをデバイスドライバーという  ソフトウェアを利用して制御している
- プロセス管理
  - プロセス(= メモリ上で実行されるプログラム)に PID(プロセス ID)という識別子を付けて管理する
  - プロセスの実行のために必要となる CPU を効率よく割り当てる役割を  している
- メモリ管理
  - プログラムやデータを物理メモリに効率よく割り当てる機能を持つ
  -  実行が終わったメモリの解放も行う
  - ディスク上の仮想メモリ領域(=スワップ)の制御も行う
    - メモリ上に展開された利用頻度の低いデータを  スワップに追い出したり(スワップアウト)、
      スワップ上のデータをメモリに戻したり(スワップイン)する

### シェル

- Linux カーネルを操作するために使用

### ファイルシステム

- Linux でハードディスクや USB メモリ、CD などのデータにアクセスするための仕組み
- データを理由する側からそのデータが保存されている場などを意識せずに透過的にアクセスできる

### セキュリティ

- アカウントによる権限設定
  - そのシステムを利用できるユーザーアカウントに権限を設定できる
  - 「root」というシステム全体を管理できる特権ユーザーとその他の一般ユーザーにがある
  -  アカウントにはグループの設定も可能。グループごとに細かく権限(=パーミッション)を設定できる 
- ネットワークフィルタリンングによる  機能

  - パケットフィルタリング ... パケットのヘッダ部分(送信元 IP アドレス、宛先 IP アドレス、ポート番号など)を見て、条件と一致すればあるアクションを実行するもの。
  - ファイアウォールのような役目

- SELinux(Security-Enhanced Linux)
  - Linux カーネルに  強制アクセス制御機能を付加する機能
    - TE(Type Enforcement) ... セキュリティの対象に応じて HTTP/FTP と行ったプロセスごとにアクセス制限をかける
    - ロールベースアクセス制御(RBAC) ... root も含む全てのユーザーに関して制限をかける

#  ミドルウェアの基礎知識

OS と  アプリケーションとの中間に入るソフトウェア

- OS の機能を  拡張したもの
- アプリケーションで使う共通機能を提供するもの
- 各種サーバ機能を提供するもの
- ...

代表例としては以下

## Web サーバ/Web アプリケーションサーバ

- クライアントのブラウザからの HTTP リクエストを受け、Web コンテンツをレスポンスとして返したり、他のサーバサイドプログラムを呼び出す機能を持つ

(代表的な Web サーバ)

- Apache HTTP Server
  - オープンソースの Web サーバ
  - 規模を選ばず利用される
- Internet Information Services
  - MicroSoft が提供する Web サーバ
  - 業務システムでよく使われる
- Nginx
  - オープンソースの Web サーバ
  - 消費メモリが少ない
  - リバースプロキシ機能やロードバランサー機能を持つのが特徴
  - toC 向けの大規模サイト中心にシェアを拡大

## データベースサーバ

- システムが生成する様々な  データを管理するためのミドルウェア
- データの検索/登録/変更/削除の基本機能に加えて、トランザクション処理などを含む  
  => データベース管理システム(DBMS, Database Management System)と呼ばれることもある

(代表的なデータベースサーバ)

- MySQL
  - Oracle が提供するオープンソースのリレーショナルデータベース管理システム
  - 世界で最も普及している
- PostgreSQL
  - オープンソースの RDBMS
  - 業務システムでよく利用される
- Oracle Database
  - Oracle が開発している商用 RDBMS
  -  業務システムで最も使用される

### NoSQL

- RDBMS とは異なり並列分散処理や柔軟なスキーマ設定が可能なことが  特徴
- 主な方式
  - KVS(Key-Value ストア)
  - ドキュメント志向データベース
  - XML データベース
- 大量データの蓄積や整列処理が得意なため、多数のユーザーからのアクセス  処理が想定されるオンラインシステムなどで広く利用される 

(代表的な NoSQL)

- Redis
  -  メモリ上に KVS を  構築できる OSS の NoSQL
  - メモリ上のデータは定期的にバックアップされるが、データが更新されるたびに記録される訳ではない  
    => 予期せぬ電源断などでデータが失われることも
- MongoDB
  - ドキュメントと呼ばれる構造的データをコレクションとして管理する OSS の NoSQL
  - オンラインゲームやログ分析などに利用される
- Apache Cassandra
  - 1 つの key に対して複数のカラムをの持ち、リレーショナルモデルに近いデータ構造をもつ OSS の NoSQL
  - 元は Facebook 社において対規模データの格納のために開発されたもの

## システム監視ツール

- インフラの  運用管理において、システムの稼動状態を監視する必要がある

(代表的なシステム監視ツール)

- Zabbix
  - さまざまなサーバの状態を監視・追跡するためのオープンソース  ソフトウェア
- Datadog
  - Datadog によって開発されているサーバを統合監視するための SaaS
- Mackerel
  - はてなによって開発されているサーバを統合監視するための SaaS

# インフラ構成管理の基礎知識

##  インフラ構成管理ツール

### OS の起動を自動化するツール(Boostrapping)

- OS インストール
- 仮想環境の設定
- ネットワークの構成の設定

(ex)

- Vagrant

### OS やミドルウェアの設定を自動化するツール(Configuration)

- OS の設定(セキュリティ、サービス起動など)
- ミドルウェアのインストールや設定

(ex)

- Chef
  - オープンソースの Ruby による  インフラ構成管理ツール
- Ansible
  - python で実装
- Puppet
- Itamae

### 複数サーバの管理を自動化するツール(Orchestration)

- アプリケーションのデプロイ
- サーバ群のオーケストレーション

(ex)

- Kubernetes
  - デファクトスタンダード
  -  コンテナ仮想環境において複数のコンテナを統合管理するツール

# コンテナ技術の概要

## コンテナ

- ホスト OS 上に論理的な区画(コンテナ)を作り、必要なライブラリやアプリケーションなどを１つに  まとめて、**あたかも個別のサーバのように使うことができる**ようにしたもの
- コンテナのオーバーヘッドが少ないため、**軽量で高速**に動作する
  - オーバーヘッド ... 仮想化を行うために必要となる CPU リソース、ディスク  容量、メモリ使用量
- アプリケーションの実行に必要なモジュールをコンテナとしてまとめられるため、複数のコンテナを組み合わせて１つのアプリケーションを構成する**マイクロサービス型のアプリケーションと親和性が高い**

## Docker の概要

- アプリケーションの実行に必要な環境を１つのイメージにまとめ、そのイメージを使って  様々な環境でアプリケーション実行環境を構築・運用するためのオープンソースのプラットフォーム
- Docker の内部ではコンテナ技術を使用している

##Docker の機能

### Docker イメージを作る機能(Build)

- Docker イメージ ... アプリケーションの実行に必要なプログラム本体、ライブラリ、ミドルウェアや OS、ネットワーク設定などを１つにまとめたもの
- １つのイメージに１つのアプリケーションのみを入れておき、複数のコンテナを組み合わせてサービスを構築する  手法が推奨されている
- Docker イメージの  実体は  アプリケーションに必要なファイル群が格納されたディレクトリ

(作成方法)

- Docker コマンドを使用して手動で作成
- (推奨)Dockerfile を設定して自動で作成

### Docker イメージを共有する機能(Ship)

- Docker イメージは Docker レジストリで共有できる
- 公式の Docker レジストリは Docker Hub

(共有方法)

- Docker コマンドを用いて Docker Hub にログインし、ダウンロードやアップロードが行える

### Docker  コンテナを動かす機能(Run)

- Linux 上でコンテナ単位でサーバ機能を動かす元になるが Docker イメージ
- Docker イメージさえあれば、 Docker がインストールされた場所ならどこでもコンテナを動かせる
- Docker イメージから複数のコンテナを動かすことも可能

### Docker のコンポーネント

- Docker は  いくつかのコンポーネントから構成される

- Docker Engine(コア機能)
  - Docker コマンドの実行
  - Dockerfile によるイメージの生成
- Docker Resitory(イメージの公開・共有)
- Docker Compose(複数コンテナの一元管理)
  - アプリケーションの実行環境を  構成するコンテナ群を一元管理するツール
- Docker Machine(実行環境構築)
  - AWS EC2 などのクラウド環境に Docker の実行環境をコマンドで自動生成するためのツール
- Docker Swarm(クラスタ管理)
  - 複数の Docker ホストをクラスタ化するためのツール
    - Manager ... クラスタ管理、API の提供
    - Node ... Docker コンテナを実行する役割

## Docker が動く仕組み
